<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>You Are The Light</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: sans-serif;
    font-size: 2rem;
    text-align: center;
    color: white;
    background-color: black;
    transition: background-color 0.05s;
  }

  #message {
    transition: opacity 2s;
  }

  #startButton {
    padding: 1rem 2rem;
    font-size: 2rem;
    cursor: pointer;
    display: none;
  }

  audio {
    display: none;
  }
</style>
</head>
<body>

<div id="message">You'll be soon Nicole's Light</div>
<button id="startButton">Start</button>

<audio id="song" src="audio/Get Together.mp3"></audio>

<!-- Pusher JS -->
<script src="https://js.pusher.com/8.2/pusher.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

  // Check URL for ?control=true
  const urlParams = new URLSearchParams(window.location.search);
  let isControl = urlParams.get('control') === 'true';

  // Extra safety: if page is on localhost or control=true query, treat as control
  if(location.hostname === "localhost") isControl = true;

  const message = document.getElementById('message');
  const startButton = document.getElementById('startButton');
  const audio = document.getElementById('song');

  // Pusher credentials
  const PUSHER_KEY = "30c6a2b5192e79fdcbdc";
  const PUSHER_CLUSTER = "eu";

  const pusher = new Pusher(PUSHER_KEY, { cluster: PUSHER_CLUSTER });
  const channel = pusher.subscribe('strobe_channel');

  if(isControl){
    // CONTROL MODE
    message.style.display = 'none';
    startButton.style.display = 'block';

    startButton.addEventListener('click', async () => {
      startButton.style.display = 'none';
      await audio.play(); // music plays on control only

      // Trigger audience via public Node.js server
      fetch("https://light-audience.onrender.com/start", { method: "POST" })
        .then(res => res.json())
        .then(console.log)
        .catch(console.error);
    });

  } else {
    // AUDIENCE MODE
    let firstBeat = true;

    channel.bind('START', () => {
      if(firstBeat){
        message.style.opacity = '0'; // fade text
        firstBeat = false;
      }
      startRandomStrobe();
    });
  }

  // Random strobe function
  function startRandomStrobe(){
    let isWhite = false;

    function animate(){
      const intensity = Math.random();
      const delay = 50 + Math.random()*250;

      if(intensity > 0.7){
        document.body.style.transition = 'background-color 0.05s';
        document.body.style.backgroundColor = isWhite ? 'black' : 'white';
      } else {
        document.body.style.transition = 'background-color 0.2s';
        document.body.style.backgroundColor = isWhite ? '#222' : '#eee';
      }

      isWhite = !isWhite;
      setTimeout(animate, delay);
    }

    animate();
  }

});
</script>

</body>
</html>
