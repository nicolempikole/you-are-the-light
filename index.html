<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>You Are The Light - Demo</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    width: 100%;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: sans-serif;
    font-size: 2rem;
    text-align: center;
    color: white;
    background-color: black;
    transition: background-color 0.05s;
  }

  #message { transition: opacity 2s; }
  #startButton { padding: 1rem 2rem; font-size: 2rem; cursor: pointer; display: none; }
  audio { display: none; }
</style>
</head>
<body>
<div id="message">You are now connected.<br>Waiting for Startâ€¦</div>
<button id="startButton">Start</button>

<audio id="song" src="audio/Get Together.mp3"></audio>

<script>
const urlParams = new URLSearchParams(window.location.search);
const isControl = urlParams.get('control') === 'true';
const message = document.getElementById('message');
const startButton = document.getElementById('startButton');
const audio = document.getElementById('song');

// BroadcastChannel for communication between tabs
const channel = new BroadcastChannel('strobe_channel');

if(isControl){
  message.style.display = 'none';
  startButton.style.display = 'block';

  startButton.addEventListener('click', () => {
    startButton.style.display = 'none';
    audio.play();

    // Notify audience tabs
    channel.postMessage({ action: 'START' });
  });

} else {
  // AUDIENCE PAGE
  message.style.display = 'block';
  document.body.style.backgroundColor = 'black';
  let firstBeat = true;

  channel.onmessage = (event) => {
    if(event.data.action === 'START'){
      if(firstBeat){
        message.style.opacity = '0';
        firstBeat = false;
      }
      startRandomStrobe();
    }
  };
}

// Random strobe
function startRandomStrobe(){
  let isWhite = false;
  function animate(){
    const intensity = Math.random();
    const delay = 50 + Math.random()*250;

    if(intensity > 0.7){
      document.body.style.transition = 'background-color 0.05s';
      document.body.style.backgroundColor = isWhite ? 'black' : 'white';
    } else {
      document.body.style.transition = 'background-color 0.2s';
      document.body.style.backgroundColor = isWhite ? '#222' : '#eee';
    }
    isWhite = !isWhite;
    setTimeout(animate, delay);
  }
  animate();
}
</script>
</body>
</html>
