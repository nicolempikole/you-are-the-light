<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>You Are The Light - Test</title>
<style>
  html, body {
    margin: 0;
    height: 100%;
    width: 100%;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: sans-serif;
    font-size: 2rem;
    text-align: center;
    color: white;
    background-color: black;
    transition: background-color 0.05s;
  }

  #message {
    transition: opacity 2s;
  }

  #startButton {
    padding: 1rem 2rem;
    font-size: 2rem;
    cursor: pointer;
    display: none;
  }

  audio {
    display: none;
  }
</style>
</head>
<body>
<div id="message">You are now connected.<br>The experience will start soon.</div>
<button id="startButton">Start</button>

<audio id="song" src="audio/Get Together.mp3"></audio>

<!-- Pusher JS -->
<script src="https://js.pusher.com/8.2/pusher.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const isControl = window.location.search.includes("control=true");
  const message = document.getElementById('message');
  const startButton = document.getElementById('startButton');
  const audio = document.getElementById('song');

  // Pusher sandbox credentials
  const PUSHER_KEY = "30c6a2b5192e79fdcbdc";
  const PUSHER_CLUSTER = "eu";

  Pusher.logToConsole = true;
  const pusher = new Pusher(PUSHER_KEY, { cluster: PUSHER_CLUSTER });
  const channel = pusher.subscribe('strobe_channel');

  if(isControl){
    // CONTROL PAGE
    message.style.display = 'none';
    startButton.style.display = 'block';

    startButton.addEventListener('click', async () => {
      startButton.style.display = 'none';
      audio.play();

      // Send START signal to all audience devices
      // Sandbox allows client-triggered events (must start with "client-")
      channel.trigger('client-start', {});
    });

  } else {
    // AUDIENCE PAGE
    message.style.display = 'block';
    document.body.style.backgroundColor = 'black';
    let firstBeat = true;

    channel.bind('client-start', () => {
      if(firstBeat){
        message.style.opacity = '0';
        firstBeat = false;
      }
      // Start random strobe
      startRandomStrobe();
    });
  }

  // Random strobe function
  function startRandomStrobe(){
    let isWhite = false;
    function animate(){
      // Random interval 50msâ€“300ms
      const delay = 50 + Math.random()*250;
      document.body.style.backgroundColor = isWhite ? 'black' : 'white';
      isWhite = !isWhite;
      setTimeout(animate, delay);
    }
    animate();
  }
});
</script>
</body>
</html>
