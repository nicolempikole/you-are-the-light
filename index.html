<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>I Trance</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: black;
  width: 100%;
  height: 100%;
  overflow: hidden;
}

#gate, #control {
  position: fixed;
  inset: 0;
  background: black;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: sans-serif;
  font-size: 2rem;
  z-index: 10;
}

#control {
  flex-direction: column;
  gap: 1rem;
  display: none;
}

#screen {
  position: fixed;
  inset: 0;
  background: black;
}
</style>
</head>

<body>

<div id="gate">Tap to enter the trance</div>

<div id="control">
  <button id="start">Start Performance</button>
  <button id="kill">Emergency Kill</button>
</div>

<div id="screen"></div>

<audio id="audio" src="Get Together.mp3"></audio>

<script>
const params = new URLSearchParams(location.search);
const isControl = params.get("control") === "true";

const gate = document.getElementById("gate");
const control = document.getElementById("control");
const screen = document.getElementById("screen");
const audio = document.getElementById("audio");

let armed = false;
let strobeInterval = null;

/* ---------- CONTROL MODE ---------- */
if (isControl) {
  gate.style.display = "none";
  control.style.display = "flex";
  audio.volume = 1;

  document.getElementById("start").onclick = () => {
    localStorage.setItem("itrance:start", Date.now());
    audio.currentTime = 0;
    audio.play();
  };

  document.getElementById("kill").onclick = () => {
    localStorage.setItem("itrance:kill", Date.now());
    audio.pause();
  };
}

/* ---------- AUDIENCE MODE ---------- */
if (!isControl) {
  audio.muted = true;

  gate.addEventListener("click", async () => {
    await document.documentElement.requestFullscreen();
    gate.style.display = "none";
    armed = true;
  });
}

/* ---------- SYNC LISTENERS ---------- */
window.addEventListener("storage", e => {

  if (!armed) return;

  if (e.key === "itrance:start") {
    startStrobe();
  }

  if (e.key === "itrance:kill") {
    stopStrobe();
  }
});

/* ---------- STROBE ---------- */
function startStrobe() {
  stopStrobe();

  strobeInterval = setInterval(() => {
    const v = Math.random() > 0.5 ? "white" : "black";
    screen.style.background = v;
  }, 60 + Math.random() * 200);
}

function stopStrobe() {
  clearInterval(strobeInterval);
  strobeInterval = null;
  screen.style.background = "black";
}
</script>

</body>
</html>
